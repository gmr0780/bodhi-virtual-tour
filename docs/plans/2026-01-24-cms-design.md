# Bodhi Virtual Tour CMS - Design Document

## Overview

A content management system for the Bodhi Virtual Tour that allows a small team (2-5 people) to manage all tour content through a web interface instead of editing JSON files manually.

## Architecture

```
┌─────────────────┐      ┌─────────────────┐
│   CMS Admin     │      │    Railway      │
│   (React app)   │─────▶│   - API server  │
│                 │      │   - Postgres DB │
└─────────────────┘      └─────────────────┘
                                │
                    On "Publish" │
                                ▼
                         ┌─────────────────┐
                         │     GitHub      │
                         │ - tourData.json │
                         │ - screenshots/  │
                         └─────────────────┘
                                │
                    Auto-deploy │
                                ▼
                         ┌─────────────────┐
                         │  Vercel (Tour)  │
                         └─────────────────┘
```

### Data Flow

1. Team edits tour content in CMS (stored in Postgres for drafts)
2. Click "Publish" → CMS commits `tourData.json` + images to GitHub
3. Vercel auto-deploys the updated tour
4. Tour app stays simple - just reads static JSON (no API calls)

### Why This Approach

- Tour stays fast (static files, no database calls)
- CMS handles the complexity (drafts, image uploads, publishing)
- Clean separation between editing and delivery

## Features & Screens

### Dashboard
- Overview of tour: roles, topics, screens, hotspots count
- "Publish" button (commits to GitHub)
- Last published date, publish status

### Roles Manager
- List all roles (GM, Engineering, IT)
- Add/edit/delete roles
- Set name, description, icon, video URL
- Drag to reorder recommended topics per role

### Topics Manager
- List all topics (Energy, Guest Experience, etc.)
- Add/edit/delete topics
- Set name, description, icon
- Manage screens within each topic

### Screen Editor
- Upload/replace screenshot image
- Visual hotspot editor (drag to position)
- Add/edit/delete hotspots
- For each hotspot: title, description, AI-powered toggle

### Settings
- CTA button text and URL
- Manage team members (GitHub usernames with access)

### Publish Flow
- Preview changes before publishing
- One-click publish to GitHub
- See deploy status from Vercel webhook

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | React + Tailwind |
| Backend | Node.js + Express |
| Database | PostgreSQL on Railway |
| Auth | GitHub OAuth |
| File uploads | Temporary storage → commit to GitHub |
| GitHub API | Octokit (for commits) |

## Database Schema

### users
- id (uuid, primary key)
- github_id (integer, unique)
- github_username (varchar)
- avatar_url (varchar)
- created_at (timestamp)

### roles
- id (uuid, primary key)
- name (varchar)
- description (text)
- icon (varchar)
- video_url (varchar)
- recommended_topics (jsonb array)
- order (integer)

### topics
- id (uuid, primary key)
- name (varchar)
- description (text)
- icon (varchar)
- order (integer)

### screens
- id (uuid, primary key)
- topic_id (uuid, foreign key)
- title (varchar)
- image_path (varchar)
- order (integer)

### hotspots
- id (uuid, primary key)
- screen_id (uuid, foreign key)
- x (decimal)
- y (decimal)
- title (varchar)
- description (text)
- ai_powered (boolean)
- order (integer)

### settings
- key (varchar, primary key)
- value (jsonb)

### publish_history
- id (uuid, primary key)
- user_id (uuid, foreign key)
- commit_sha (varchar)
- published_at (timestamp)

## Project Structure

```
bodhi-virtual-tour/
├── apps/
│   ├── tour/          (existing tour - moves here)
│   │   ├── src/
│   │   ├── public/
│   │   └── package.json
│   └── cms/           (new CMS app)
│       ├── client/    (React frontend)
│       │   ├── src/
│       │   └── package.json
│       └── server/    (Node API)
│           ├── src/
│           └── package.json
├── public/
│   └── screenshots/   (shared, committed by CMS)
├── package.json       (workspace root)
└── tourData.json      (generated by CMS)
```

## Deployment

| App | Platform | Trigger |
|-----|----------|---------|
| Tour | Vercel | GitHub push (auto) |
| CMS | Railway | GitHub push (auto) |
| Postgres | Railway | Always on |

## Environment Variables

### CMS Server
```
DATABASE_URL=postgresql://...
GITHUB_CLIENT_ID=...
GITHUB_CLIENT_SECRET=...
GITHUB_REPO=gmr0780/bodhi-virtual-tour
GITHUB_TOKEN=... (for commits)
SESSION_SECRET=...
```

## Authentication

- GitHub OAuth for team login
- Allowed users stored in settings table (GitHub usernames)
- All authenticated users have equal permissions

## Publish Process

1. User clicks "Publish" in CMS
2. CMS reads all data from Postgres tables
3. Generates `tourData.json` matching the existing format
4. Uses Octokit to:
   - Upload any new/changed images to `public/screenshots/`
   - Update `tourData.json`
   - Create a commit with message "Update tour content"
5. Records publish in history table
6. Vercel detects GitHub push, auto-deploys tour

## Success Criteria

- Team can manage all tour content without touching code
- Changes publish to live tour with one click
- Visual hotspot positioning (drag and drop)
- Image uploads handled seamlessly
- GitHub remains source of truth for deployed content
